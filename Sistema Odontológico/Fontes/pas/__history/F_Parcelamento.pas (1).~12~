unit F_Parcelamento;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Padrao, cxGraphics, cxControls,
  cxLookAndFeels, cxLookAndFeelPainters, cxContainer, cxEdit, dxSkinsCore,
  dxSkinsDefaultPainters, Vcl.StdCtrls, Vcl.Mask, JvExMask, JvToolEdit,
  cxTextEdit, cxCurrencyEdit, JvComponentBase, JvEnterTab, Vcl.ComCtrls,
  Vcl.ExtCtrls, Data.DB, Data.Win.ADODB, Vcl.Grids, Vcl.DBGrids, JvExDBGrids,
  JvDBGrid, JvDBUltimGrid, Vcl.Buttons;

type
  TfrmParcelamento = class(TfrmPadrao)
    GroupBox1: TGroupBox;
    Label1: TLabel;
    EdtValor: TcxCurrencyEdit;
    Label2: TLabel;
    EdtDtConta: TJvDateEdit;
    Label3: TLabel;
    EdtParcelas: TEdit;
    GroupBox2: TGroupBox;
    gridPagamento: TJvDBUltimGrid;
    qryParcelas: TADOQuery;
    qryParcelasDataPgto: TDateTimeField;
    qryParcelasValor: TFloatField;
    dsParcelas: TDataSource;
    SpeedButton6: TSpeedButton;
    btnFechar: TSpeedButton;
    btnSalvar: TSpeedButton;
    qryAux: TADOQuery;
    procedure btnFecharClick(Sender: TObject);
    procedure SpeedButton6Click(Sender: TObject);
    procedure FormActivate(Sender: TObject);
  private
    { Private declarations }
  public
    iIDContaPagar : Integer;
    Procedure CarregaConta;
  end;

var
  frmParcelamento: TfrmParcelamento;

implementation

{$R *.dfm}

procedure TfrmParcelamento.btnFecharClick(Sender: TObject);
begin
  inherited;
  Close;
end;

procedure TfrmParcelamento.CarregaConta;
begin
  With qryAux do
    Begin
      Close;
      SQL.Clear;
      SQL.Add('SELECT * FROM CONTAPAGAR');
      SQL.Add('WHERE ID_CONTAPAGAR = :pID');
      Parameters.ParamByName('pID').Value := iIDContaPagar;
      Open;

      EdtValor.Value := FieldByName('VALORRESTANTE').AsFloat;
      EdtDtConta.Date := FieldByName('DTAVENCIMENTO').AsDateTime;
    End;
end;

procedure TfrmParcelamento.FormActivate(Sender: TObject);
begin
  inherited;
  EdtParcelas.SetFocus;
end;

procedure TfrmParcelamento.SpeedButton6Click(Sender: TObject);
var
  i : integer;
  dDataVcto : TDate;
  rValor : Double;
begin
  inherited;

  i := 0;
  dDataVcto := EdtDtConta.Date;

  With qryParcelas do
    Begin
      Close;
      Open;

      rValor := EdtValor.Value / StrToFloat(EdtParcelas.Text);

      for i := 1 to StrToInt(EdtParcelas.Text) do
        Begin
          Append;
          FieldByName('DataPgto').AsDateTime := dDataVcto;
          FieldByName('Valor').AsFloat := rValor;
          Post;

          dDataVcto := IncMonth(dDataVcto, 1);
        End;
    End;
end;

end.
